<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>CARGO STATUS ‚Äì SINGAPORE (ASTRO)</title>

  <link rel="stylesheet" href="../../../assets/css/style.css" />

  <style>
    body{
      font-family: "Segoe UI", Arial, sans-serif;
      background:#f2f5f9;
      margin:0;
      padding:20px;
    }
    .container{
      max-width:1280px;
      margin:auto;
      background:#fff;
      border-radius:18px;
      box-shadow:0 10px 28px rgba(0,0,0,.10);
      padding:22px;
    }
    h1{
      margin:0 0 16px;
      text-align:center;
      color:#0f172a;
      font-weight:900;
      letter-spacing:.3px;
    }

    /* FORM */
    form{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:10px;
      margin-bottom:14px;
    }
    form input{
      padding:10px 10px;
      border-radius:10px;
      border:1px solid #d1d5db;
      font-size:14px;
      color:#0f172a;
      background:#fff;
    }
    .btnbar{
      grid-column:span 4;
      display:flex;
      gap:10px;
      justify-content:flex-start;
      flex-wrap:wrap;
      margin-top:2px;
    }
    .btn-save{
      flex:1;
      padding:12px 14px;
      border:none;
      border-radius:12px;
      cursor:pointer;
      font-weight:900;
      letter-spacing:.3px;
      background:#007bff;
      color:#fff;
      box-shadow:0 8px 0 #003e86, 0 14px 22px rgba(0,0,0,.12);
      transition:.12s ease;
      user-select:none;
    }
    .btn-save:active{
      transform:translateY(6px);
      box-shadow:0 2px 0 #003e86, 0 10px 16px rgba(0,0,0,.10);
    }

    .btn-search{
      width:56px;
      min-width:56px;
      padding:12px 0;
      border:none;
      border-radius:12px;
      cursor:pointer;
      font-weight:900;
      background:#0f172a;
      color:#fff;
      box-shadow:0 8px 0 #0a0f1f, 0 14px 22px rgba(0,0,0,.12);
      transition:.12s ease;
      user-select:none;
    }
    .btn-search:active{
      transform:translateY(6px);
      box-shadow:0 2px 0 #0a0f1f, 0 10px 16px rgba(0,0,0,.10);
    }

    /* TABLE */
    .table-wrap{
      overflow:auto;
      border-radius:14px;
      border:1px solid #e5e7eb;
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width:1100px;
    }
    th,td{
      border-bottom:1px solid #e5e7eb;
      border-right:1px solid #e5e7eb;
      padding:10px 10px;
      text-align:center;
      font-size:13px;
      color:#0f172a;
      background:#fff;
      white-space:nowrap;
    }
    th:first-child, td:first-child{ border-left:1px solid #e5e7eb; }
    thead th{
      position:sticky;
      top:0;
      z-index:5;
      background:#f8fafc;
      font-weight:900;
      letter-spacing:.3px;
    }

    /* DONE EFFECT */
    tr.done-row td{
      background: #dcfce7;      /* full green row */
      border-color:#bbf7d0;
    }
    .done-badge{
      display:inline-block;
      padding:7px 10px;
      font-size:12px;
      font-weight:900;
      border-radius:999px;
      background:#16a34a;
      color:#fff;
    }

    /* ACTION ICONS */
    .actions{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .icon-btn{
      width:34px;
      height:34px;
      border:none;
      border-radius:10px;
      cursor:pointer;
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 5px 0 rgba(0,0,0,.22), 0 10px 16px rgba(0,0,0,.12);
      transition:.12s ease;
      user-select:none;
    }
    .icon-btn:active{
      transform:translateY(4px);
      box-shadow:0 2px 0 rgba(0,0,0,.22), 0 7px 12px rgba(0,0,0,.10);
    }
    .btn-edit{ background:#f59e0b; color:#111; }
    .btn-del{ background:#ef4444; color:#fff; }

    /* FILTER BUTTON IN HEADER */
    .th-flex{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .filter-btn{
      border:none;
      border-radius:8px;
      cursor:pointer;
      font-weight:900;
      font-size:12px;
      padding:4px 8px;
      background:#e2e8f0;
      color:#0f172a;
    }
    .filter-btn:hover{ background:#cbd5e1; }

    /* DROPDOWN */
    .dropdown{
      position:fixed;
      z-index:9999;
      min-width:220px;
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:12px;
      box-shadow:0 18px 40px rgba(0,0,0,.18);
      overflow:hidden;
      display:none;
    }
    .drop-head{
      padding:10px;
      border-bottom:1px solid #e5e7eb;
      background:#f8fafc;
      font-weight:900;
      font-size:12px;
      letter-spacing:.3px;
    }
    .drop-search{
      padding:10px;
      border-bottom:1px solid #e5e7eb;
    }
    .drop-search input{
      width:100%;
      padding:9px 10px;
      border-radius:10px;
      border:1px solid #d1d5db;
      font-size:13px;
    }
    .drop-list{
      max-height:240px;
      overflow:auto;
    }
    .drop-item{
      padding:10px;
      font-size:13px;
      cursor:pointer;
      text-align:left;
      border-bottom:1px solid #f1f5f9;
    }
    .drop-item:hover{ background:#f1f5f9; }
    .drop-foot{
      display:flex;
      gap:8px;
      padding:10px;
      border-top:1px solid #e5e7eb;
      background:#fff;
    }
    .drop-foot button{
      flex:1;
      padding:9px 10px;
      border:none;
      border-radius:10px;
      cursor:pointer;
      font-weight:900;
      font-size:12px;
    }
    .btn-clear{ background:#e2e8f0; color:#0f172a; }
    .btn-apply{ background:#0f172a; color:#fff; }

    .toolbar-bottom{
      margin-top:14px;
      display:flex;
      justify-content:flex-start;
    }
    .btn-back{
      padding:10px 16px;
      background:#0f172a;
      color:#fff;
      border:none;
      border-radius:12px;
      cursor:pointer;
      font-weight:900;
      box-shadow:0 6px 0 rgba(0,0,0,.22), 0 10px 16px rgba(0,0,0,.12);
      transition:.12s ease;
      user-select:none;
    }
    .btn-back:active{
      transform:translateY(5px);
      box-shadow:0 2px 0 rgba(0,0,0,.22), 0 7px 12px rgba(0,0,0,.10);
    }

    @media (max-width: 900px){
      form{ grid-template-columns:repeat(2,1fr); }
      .btnbar{ grid-column:span 2; }
    }
    @media (max-width: 520px){
      form{ grid-template-columns:1fr; }
      .btnbar{ grid-column:span 1; }
      .btn-search{ width:100%; min-width:100%; }
    }
  </style>
</head>

<body onload="checkLogin()">

  <div class="container">
    <h1>CARGO STATUS ‚Äì SINGAPORE (ASTRO)</h1>

    <form id="cargoForm" autocomplete="off">
      <input id="bl" placeholder="BL NO" required />
      <input id="destination" placeholder="DESTINATION" required />

      <!-- AUTO DATE (EXCEL STYLE) -->
      <input id="etd" placeholder="ETD (DD/MM/YYYY)" required />
      <input id="eta" placeholder="ETA (DD/MM/YYYY)" required />

      <input id="vessel" placeholder="VESSEL" required />
      <input id="connect" placeholder="CONNECTING VESSEL" required />

      <input id="doRelease" placeholder="DO RELEASE (DD/MM/YYYY)" required />
      <input id="cargoRelease" placeholder="CARGO RELEASE (DD/MM/YYYY)" required />

      <div class="btnbar">
        <button class="btn-save" type="submit" id="btnSave">SAVE & PUBLISH</button>
        <button class="btn-search" type="button" id="btnSearch" title="SEARCH BL">üîç</button>
      </div>
    </form>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th style="width:160px;">BL NO</th>
            <th style="width:170px;">DESTINATION</th>

            <!-- FILTER IN HEADER (NO EXTRA FILTER BAR) -->
            <th style="width:140px;">
              <div class="th-flex">
                ETD
                <button class="filter-btn" data-filter="etd">‚ñº</button>
              </div>
            </th>

            <th style="width:140px;">
              <div class="th-flex">
                ETA
                <button class="filter-btn" data-filter="eta">‚ñº</button>
              </div>
            </th>

            <th style="width:160px;">
              <div class="th-flex">
                VESSEL
                <button class="filter-btn" data-filter="vessel">‚ñº</button>
              </div>
            </th>

            <th style="width:180px;">CONNECTING VESSEL</th>
            <th style="width:160px;">DO RELEASE</th>
            <th style="width:90px;">
              <div class="th-flex">
                STATUS
                <button class="filter-btn" data-filter="status">‚ñº</button>
              </div>
            </th>
            <th style="width:130px;">ACTION</th>
          </tr>
        </thead>

        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <div class="toolbar-bottom">
      <button class="btn-back" onclick="history.back()">‚¨Ö BACK</button>
    </div>
  </div>

  <!-- Dropdown Filter -->
  <div id="dropdown" class="dropdown" aria-hidden="true">
    <div id="dropTitle" class="drop-head">FILTER</div>
    <div class="drop-search">
      <input id="dropSearch" type="text" placeholder="SEARCH..." />
    </div>
    <div id="dropList" class="drop-list"></div>
    <div class="drop-foot">
      <button id="btnClear" class="btn-clear" type="button">CLEAR</button>
      <button id="btnApply" class="btn-apply" type="button">APPLY</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getFirestore, doc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    /* ========= FIREBASE ========= */
    const firebaseConfig = {
      apiKey: "AIzaSyAu0br1o29T7QM7StyHezHlZ67WiVsTzx0",
      authDomain: "transshipment-8c2da.firebaseapp.com",
      projectId: "transshipment-8c2da",
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* ========= STORAGE ========= */
    const STORAGE_KEY = "cargo_sg_astro_data_v2";
    let cargos = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];

    const form = document.getElementById("cargoForm");
    const tbody = document.getElementById("tableBody");

    /* ========= FILTER STATE ========= */
    const filters = {
      etd: "ALL",
      eta: "ALL",
      vessel: "ALL",
      status: "ALL"
    };

    /* ========= DATE AUTO FORMAT (EXCEL STYLE) ========= */
    function autoFormatDMY(value){
      if(!value) return "";
      let v = value.trim()
        .replaceAll("-", "/")
        .replaceAll(".", "/")
        .replace(/\s+/g, "/");

      const parts = v.split("/").filter(Boolean);
      if(parts.length < 3) return value;

      let d = (parts[0]||"").replace(/\D/g,"");
      let m = (parts[1]||"").replace(/\D/g,"");
      let y = (parts[2]||"").replace(/\D/g,"");
      if(!d || !m || !y) return value;

      d = d.padStart(2, "0");
      m = m.padStart(2, "0");
      if(y.length === 2) y = "20" + y;
      if(y.length === 1) y = "200" + y;
      if(y.length !== 4) return value;

      return `${d}/${m}/${y}`;
    }

    function hookAutoFormat(id){
      const el = document.getElementById(id);
      if(!el) return;
      el.addEventListener("blur", ()=> el.value = autoFormatDMY(el.value));
      el.addEventListener("keydown", (e)=>{
        if(e.key === "Enter") el.value = autoFormatDMY(el.value);
      });
    }
    ["etd","eta","doRelease","cargoRelease"].forEach(hookAutoFormat);

    function normalizeBL(bl){
      return (bl||"").trim().toUpperCase().replace(/\s+/g,"");
    }
    function saveLocal(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(cargos));
    }

    /* ========= PUBLISH TO FIREBASE ========= */
    async function publishFirebase(row){
      const bl = normalizeBL(row.bl);
      if(!bl) return;

      const payload = {
        area: "singapore",
        agent: "astro",
        status: row.done ? "SHIPMENT DONE" : "IN TRANSIT",
        blNo: bl,
        destination: row.destination || "-",
        vessel: row.vessel || "-",
        eta: row.eta || "-",
        updatedAt: new Date().toISOString().slice(0,10),

        events: [
          { date: row.etd || "-", location:"SINGAPORE", description:`ETD - VESSEL: ${row.vessel || "-"}` },
          { date: row.eta || "-", location:(row.destination||"-"), description:`ETA - CONNECTING: ${row.connect || "-"}` },
          { date: row.doRelease || "-", location:(row.destination||"-"), description:"DO RELEASE" },
          { date: row.cargoRelease || "-", location:(row.destination||"-"), description:"CARGO RELEASE" }
        ]
      };

      await setDoc(doc(db, "cargo_gateway", bl), payload, { merge:true });
    }

    /* ========= RENDER TABLE ========= */
    function rowMatchesFilters(r){
      // ETD
      if(filters.etd !== "ALL" && (r.etd||"-") !== filters.etd) return false;
      // ETA
      if(filters.eta !== "ALL" && (r.eta||"-") !== filters.eta) return false;
      // VESSEL
      if(filters.vessel !== "ALL" && (r.vessel||"-") !== filters.vessel) return false;
      // STATUS
      const st = r.done ? "SHIPMENT DONE" : "IN TRANSIT";
      if(filters.status !== "ALL" && st !== filters.status) return false;

      return true;
    }

    function render(){
      tbody.innerHTML = "";

      cargos
        .filter(rowMatchesFilters)
        .forEach(r=>{
          const tr = document.createElement("tr");
          if(r.done) tr.classList.add("done-row");

          const statusText = r.done ? "SHIPMENT DONE" : "IN TRANSIT";

          tr.innerHTML = `
            <td>${r.bl}</td>
            <td>${r.destination}</td>
            <td>${r.etd}</td>
            <td>${r.eta}</td>
            <td>${r.vessel}</td>
            <td>${r.connect}</td>
            <td>${r.doRelease}</td>

            <td>
              <input type="checkbox" ${r.done ? "checked" : ""} data-id="${r.id}" class="chkDone"/>
            </td>

            <td>
              ${r.done
                ? `<span class="done-badge">‚úÖ SHIPMENT DONE</span>`
                : `<div class="actions">
                      <button class="icon-btn btn-edit" data-action="edit" data-id="${r.id}" title="EDIT">‚úèÔ∏è</button>
                      <button class="icon-btn btn-del" data-action="delete" data-id="${r.id}" title="DELETE">üóëÔ∏è</button>
                   </div>`
              }
            </td>
          `;
          tbody.appendChild(tr);
        });

      bindRowEvents();
    }

    function bindRowEvents(){
      // DONE checkbox
      document.querySelectorAll(".chkDone").forEach(cb=>{
        cb.addEventListener("change", async ()=>{
          const id = Number(cb.dataset.id);
          const row = cargos.find(x=>x.id===id);
          if(!row) return;
          row.done = !row.done;
          saveLocal();
          render();
          await publishFirebase(row);
        });
      });

      // edit/delete buttons
      tbody.querySelectorAll("button[data-action]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const id = Number(btn.dataset.id);
          const action = btn.dataset.action;
          const row = cargos.find(x=>x.id===id);
          if(!row) return;

          if(action === "edit"){
            row.destination = (prompt("DESTINATION:", row.destination) || row.destination).trim();
            row.vessel = (prompt("VESSEL:", row.vessel) || row.vessel).trim();
            row.connect = (prompt("CONNECTING VESSEL:", row.connect) || row.connect).trim();

            row.etd = autoFormatDMY(prompt("ETD (DD/MM/YYYY):", row.etd) || row.etd);
            row.eta = autoFormatDMY(prompt("ETA (DD/MM/YYYY):", row.eta) || row.eta);
            row.doRelease = autoFormatDMY(prompt("DO RELEASE (DD/MM/YYYY):", row.doRelease) || row.doRelease);
            row.cargoRelease = autoFormatDMY(prompt("CARGO RELEASE (DD/MM/YYYY):", row.cargoRelease) || row.cargoRelease);

            saveLocal();
            render();
            await publishFirebase(row);
          }

          if(action === "delete"){
            if(!confirm("DELETE THIS SHIPMENT?")) return;
            const bl = normalizeBL(row.bl);
            cargos = cargos.filter(x=>x.id!==id);
            saveLocal();
            render();
            await deleteDoc(doc(db, "cargo_gateway", bl));
          }
        });
      });
    }

    /* ========= ADD NEW SHIPMENT (NEWEST ON TOP) ========= */
    form.addEventListener("submit", async (e)=>{
      e.preventDefault();

      // apply auto format before save
      const bl = normalizeBL(document.getElementById("bl").value);
      const destination = document.getElementById("destination").value.trim().toUpperCase();

      const etd = autoFormatDMY(document.getElementById("etd").value);
      const eta = autoFormatDMY(document.getElementById("eta").value);

      const vessel = document.getElementById("vessel").value.trim().toUpperCase();
      const connect = document.getElementById("connect").value.trim().toUpperCase();

      const doRelease = autoFormatDMY(document.getElementById("doRelease").value);
      const cargoRelease = autoFormatDMY(document.getElementById("cargoRelease").value);

      if(!bl) return alert("BL NO IS REQUIRED!");

      // update inputs to formatted values
      document.getElementById("etd").value = etd;
      document.getElementById("eta").value = eta;
      document.getElementById("doRelease").value = doRelease;
      document.getElementById("cargoRelease").value = cargoRelease;

      // prevent duplicate BL
      const exists = cargos.find(x=>normalizeBL(x.bl) === bl);
      if(exists){
        alert("BL NO ALREADY EXISTS. PLEASE USE EDIT.");
        return;
      }

      const row = {
        id: Date.now(),
        bl,
        destination,
        etd, eta,
        vessel, connect,
        doRelease, cargoRelease,
        done:false
      };

      // ‚úÖ NEWEST ON TOP
      cargos.unshift(row);

      saveLocal();
      render();
      form.reset();

      await publishFirebase(row);
    });

    /* ========= SEARCH BUTTON (BL) ========= */
    document.getElementById("btnSearch").addEventListener("click", ()=>{
      const bl = prompt("SEARCH BL NO:");
      if(!bl) return;
      const key = normalizeBL(bl);
      const found = cargos.find(x=>normalizeBL(x.bl) === key);
      if(!found) return alert("BL NOT FOUND.");

      alert(
        `FOUND ‚úÖ\nBL: ${found.bl}\nDESTINATION: ${found.destination}\nETA: ${found.eta}\nSTATUS: ${found.done ? "SHIPMENT DONE" : "IN TRANSIT"}`
      );
    });

    /* ========= FILTER DROPDOWN (EXCEL STYLE) ========= */
    const dropdown = document.getElementById("dropdown");
    const dropTitle = document.getElementById("dropTitle");
    const dropSearch = document.getElementById("dropSearch");
    const dropList = document.getElementById("dropList");
    const btnClear = document.getElementById("btnClear");
    const btnApply = document.getElementById("btnApply");

    let currentFilterKey = null;
    let selectedValue = "ALL";

    function uniqueValues(key){
      if(key === "status"){
        return ["ALL","IN TRANSIT","SHIPMENT DONE"];
      }

      const vals = cargos.map(r=>{
        if(key === "etd") return r.etd || "-";
        if(key === "eta") return r.eta || "-";
        if(key === "vessel") return r.vessel || "-";
        return "-";
      });

      const uniq = Array.from(new Set(vals.filter(v=>v && v!=="-")));
      uniq.sort((a,b)=> String(a).localeCompare(String(b)));
      return ["ALL", ...uniq];
    }

    function openDropdown(btn, key){
      currentFilterKey = key;
      selectedValue = filters[key] || "ALL";

      dropTitle.textContent = `FILTER: ${key.toUpperCase()}`;
      dropSearch.value = "";
      renderDropList(uniqueValues(key), "");

      // position under button
      const rect = btn.getBoundingClientRect();
      dropdown.style.left = Math.min(rect.left, window.innerWidth - 260) + "px";
      dropdown.style.top = (rect.bottom + 8) + "px";
      dropdown.style.display = "block";
      dropdown.setAttribute("aria-hidden","false");

      // focus search inside dropdown
      setTimeout(()=>dropSearch.focus(), 0);
    }

    function closeDropdown(){
      dropdown.style.display = "none";
      dropdown.setAttribute("aria-hidden","true");
      currentFilterKey = null;
    }

    function renderDropList(values, query){
      const q = (query||"").toLowerCase();
      dropList.innerHTML = "";

      values
        .filter(v=> String(v).toLowerCase().includes(q))
        .forEach(v=>{
          const div = document.createElement("div");
          div.className = "drop-item";
          div.textContent = v;
          if(v === selectedValue){
            div.style.background = "#e2e8f0";
            div.style.fontWeight = "900";
          }
          div.addEventListener("click", ()=>{
            selectedValue = v;
            renderDropList(values, dropSearch.value);
          });
          dropList.appendChild(div);
        });
    }

    // search inside dropdown
    dropSearch.addEventListener("input", ()=>{
      if(!currentFilterKey) return;
      renderDropList(uniqueValues(currentFilterKey), dropSearch.value);
    });

    // clear/apply
    btnClear.addEventListener("click", ()=>{
      selectedValue = "ALL";
      if(currentFilterKey){
        filters[currentFilterKey] = "ALL";
      }
      closeDropdown();
      render();
    });

    btnApply.addEventListener("click", ()=>{
      if(!currentFilterKey) return;
      filters[currentFilterKey] = selectedValue;
      closeDropdown();
      render();
    });

    // open buttons in header
    document.querySelectorAll(".filter-btn").forEach(btn=>{
      btn.addEventListener("click", (e)=>{
        e.stopPropagation();
        const key = btn.dataset.filter;
        openDropdown(btn, key);
      });
    });

    // click outside close
    document.addEventListener("click", (e)=>{
      if(dropdown.style.display !== "block") return;
      const isInside = dropdown.contains(e.target);
      const isButton = e.target.classList.contains("filter-btn");
      if(!isInside && !isButton) closeDropdown();
    });

    // ESC close
    document.addEventListener("keydown", (e)=>{
      if(e.key === "Escape") closeDropdown();
    });

    /* ========= LOGIN CHECK ========= */
    window.checkLogin = function(){
      if(!localStorage.getItem("loginStatus")){
        alert("PLEASE LOGIN FIRST.");
        window.location.href = "../../../index.html";
      }
    };

    /* INIT */
    render();
  </script>
</body>
</html>
