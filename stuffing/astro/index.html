<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>Stuffing List - Astro (Index)</title>

  <!-- Firebase compat libs (PASTIKAN urutan ini tetap) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

  <!-- config (pastikan path benar) -->
  <script src="../firebase-config.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding:18px; background:#f6f8fb; }
    .card { max-width:920px; margin:auto; background:white; padding:16px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.07); }
    h1{ margin:0 0 12px 0; font-size:20px }
    .row{ display:flex; gap:8px; align-items:center; margin-bottom:10px; flex-wrap:wrap }
    input[type="text"]{ padding:8px; border:1px solid #ccc; border-radius:6px; }
    button{ padding:8px 12px; border-radius:6px; border:none; background:#007bff; color:#fff; cursor:pointer }
    table{ width:100%; border-collapse:collapse; margin-top:14px }
    th,td{ padding:8px; border-bottom:1px solid #eee; text-align:left }
    .muted{ color:#666; font-size:13px }
    .small{ padding:6px 8px; font-size:13px; border-radius:6px; }
    .danger{ background:#e74c3c }
  </style>
</head>
<body>
  <div class="card">
    <h1>Stuffing List â€“ Astro Pacific</h1>

    <!-- Search -->
    <div class="row">
      <input id="search" type="text" placeholder="Cari vessel atau voyage..." style="flex:1">
      <div class="muted" id="status">Memuat...</div>
    </div>

    <!-- Add vessel -->
    <div class="row">
      <input id="vesselInput" type="text" placeholder="Nama Vessel (contoh: HMM SKY)" style="flex:1">
      <input id="voyageInput" type="text" placeholder="Voyage (contoh: 021)" style="width:160px">
      <button id="btnAdd">Tambah Data</button>
    </div>

    <!-- Table -->
    <table aria-label="Daftar Vessel">
      <thead>
        <tr><th>Vessel</th><th>Voyage</th><th style="width:180px">Aksi</th></tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div style="margin-top:12px; display:flex; justify-content:space-between; align-items:center;">
      <div class="muted">Data tersimpan ke Firestore (koleksi: <code>astro_vessels</code>).</div>
      <div>
        <button onclick="location.href='../../dashboard.html'">Kembali Dashboard</button>
      </div>
    </div>
  </div>

  <script>
    // ========== Utility ==========
    function el(sel){ return document.querySelector(sel); }
    function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;'); }

    // DOM
    const tbody = el("#tbody");
    const search = el("#search");
    const vesselInput = el("#vesselInput");
    const voyageInput = el("#voyageInput");
    const btnAdd = el("#btnAdd");
    const status = el("#status");

    // Firestore collection name
    const COLL = "astro_vessels";

    // Load and render vessels
    async function loadVessels(){
      tbody.innerHTML = "<tr><td colspan='3' class='muted'>Memuat data...</td></tr>";
      try {
        const snap = await db.collection(COLL).orderBy("vessel").get();
        const rows = [];
        snap.forEach(doc => {
          const d = doc.data();
          rows.push({ id: doc.id, vessel: d.vessel||"", voyage: d.voyage||"" });
        });
        renderRows(rows);
      } catch(err){
        console.error("loadVessels error:", err);
        tbody.innerHTML = "<tr><td colspan='3' class='muted'>Gagal memuat data (cek console).</td></tr>";
      }
    }

    // Render rows with search filter
    function renderRows(rows){
      const q = (search.value||"").toLowerCase().trim();
      const filtered = rows.filter(r => (r.vessel+" "+r.voyage).toLowerCase().includes(q));
      tbody.innerHTML = "";
      if(filtered.length === 0){
        tbody.innerHTML = "<tr><td colspan='3' class='muted'>Belum ada data.</td></tr>";
      } else {
        filtered.forEach(r => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${escapeHtml(r.vessel)}</td>
            <td>${escapeHtml(r.voyage)}</td>
            <td>
              <button class="small" onclick="openVessel('${r.id}')">Lihat</button>
              <button class="small" onclick="editVessel('${r.id}')">Ubah</button>
              <button class="small danger" onclick="deleteVessel('${r.id}')">Hapus</button>
            </td>`;
          tbody.appendChild(tr);
        });
      }
      status.textContent = `Menampilkan ${filtered.length} / ${rows.length}`;
    }

    // Add vessel
    btnAdd.addEventListener("click", async () => {
      const vessel = vesselInput.value.trim();
      const voyage = voyageInput.value.trim();
      if(!vessel || !voyage){ alert("Isi Vessel dan Voyage!"); return; }
      btnAdd.disabled = true;
      try {
        await db.collection(COLL).add({ vessel, voyage, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        vesselInput.value = ""; voyageInput.value = "";
        await loadVessels();
      } catch(err){
        console.error("addVessel err:", err);
        alert("Gagal menambah data (cek console).");
      } finally { btnAdd.disabled = false; }
    });

    // open vessel detail (store id then navigate)
    function openVessel(id){
      localStorage.setItem("vessel_id", id);
      location.href = "vessel.html";
    }

    // edit vessel (simple prompt)
    async function editVessel(id){
      try {
        const doc = await db.collection(COLL).doc(id).get();
        if(!doc.exists) return alert("Data tidak ditemukan.");
        const data = doc.data();
        const nv = prompt("Ubah Vessel:", data.vessel || "");
        if(nv === null) return;
        const nvoy = prompt("Ubah Voyage:", data.voyage || "");
        if(nvoy === null) return;
        await db.collection(COLL).doc(id).update({ vessel: nv.trim(), voyage: nvoy.trim() });
        loadVessels();
      } catch(err){
        console.error("editVessel err:", err);
        alert("Gagal mengubah (cek console).");
      }
    }

    // delete vessel
    async function deleteVessel(id){
      if(!confirm("Hapus vessel dan seluruh subcollection details?")) return;
      try {
        // delete subcollection documents first (Firestore doesn't cascade automatically)
        const detailsSnap = await db.collection(COLL).doc(id).collection("details").get();
        const batch = db.batch();
        detailsSnap.forEach(d => batch.delete(d.ref));
        // delete vessel doc
        batch.delete(db.collection(COLL).doc(id));
        await batch.commit();
        loadVessels();
      } catch(err){
        console.error("deleteVessel err:", err);
        alert("Gagal menghapus (cek console).");
      }
    }

    // search typing
    let searchTimer;
    search.addEventListener("input", () => {
      clearTimeout(searchTimer);
      searchTimer = setTimeout(loadVessels, 250);
    });

    // initial load
    loadVessels();
  </script>
</body>
</html>
