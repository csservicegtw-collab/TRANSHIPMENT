<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Stuffing List - Coload</title>
  <link rel="stylesheet" href="../assets/css/base.css">
  <link rel="stylesheet" href="../assets/css/theme-coload.css">
</head>
<body>
  <div class="container">
    <h1>Stuffing List ‚Äì Coload</h1>

    <!-- üîç Search + Filter -->
    <div class="search-container">
      <div class="search-wrapper">
        <select id="filterSelect" class="search-filter">
          <option value="all">Semua</option>
          <option value="vessel">Vessel</option>
          <option value="voyage">Voyage</option>
          <option value="type">Tipe</option>
        </select>
        <input type="text" id="searchInput" class="search-input" placeholder="Cari berdasarkan kata kunci...">
      </div>
    </div>

    <!-- Form input data -->
    <form id="addForm" style="margin-top:15px;">
      <input type="text" id="vesselName" placeholder="Nama Vessel" required>
      <input type="text" id="voyageNumber" placeholder="Voyage" required>
      <select id="vesselType" required>
        <option value="Feeder">Feeder</option>
        <option value="Mother">Mother</option>
      </select>
      <button type="submit">Tambah Data</button>
    </form>

    <!-- Tabel data -->
    <table id="vesselTable">
      <thead>
        <tr>
          <th>Vessel</th>
          <th>Voyage</th>
          <th>Tipe</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button onclick="history.back()">‚¨ÖÔ∏è Kembali</button>
  </div>

  <!-- SCRIPT -->
  <script type="module">
    import { 
      initializeApp 
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";

    import { 
      getFirestore, 
      collection, 
      doc, 
      setDoc, 
      getDocs, 
      deleteDoc 
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    // === FIREBASE CONFIG ===
    const firebaseConfig = {
      apiKey: "AIzaSyAu0br1o29T7QM7StyHezHlZ67WiVsTzx0",
      authDomain: "transshipment-8c2da.firebaseapp.com",
      projectId: "transshipment-8c2da",
      storageBucket: "transshipment-8c2da.firebasestorage.app",
      messagingSenderId: "997549413633",
      appId: "1:997549413633:web:b173bddaf4b73cccd13700",
      measurementId: "G-21L0CZJ1MC"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const agent = "coload";

    // === LOCAL DATA HANDLER ===
    const STORAGE_KEY = "coload_vessels";
    let vessels = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    const tableBody = document.querySelector("#vesselTable tbody");
    const addForm = document.getElementById("addForm");

    // === SIMPAN DATA KE LOCAL STORAGE ===
    function saveData() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(vessels));
    }

    // === RENDER TABEL ===
    function renderTable() {
      tableBody.innerHTML = "";
      vessels.forEach((v, i) => {
        const row = `
          <tr>
            <td>${v.vessel}</td>
            <td>${v.voyage}</td>
            <td>${v.type}</td>
            <td>
              <button onclick="openVessel('${v.vessel}', '${v.voyage}')">Lihat</button>
              <button onclick="editVessel(${i})">Edit</button>
              <button onclick="deleteVessel(${i})">Hapus</button>
            </td>
          </tr>
        `;
        tableBody.insertAdjacentHTML("beforeend", row);
      });
    }

    // === BUKA DETAIL VESSEL ===
    window.openVessel = (vessel, voyage) => {
      localStorage.setItem("current_vessel", vessel);
      localStorage.setItem("current_voyage", voyage);
      location.href = "vessel.html";
    };

    // === EDIT DATA VESSEL ===
    window.editVessel = (i) => {
      const v = vessels[i];
      const newVessel = prompt("Ubah nama Vessel:", v.vessel);
      const newVoyage = prompt("Ubah Voyage:", v.voyage);
      const newType = prompt("Ubah tipe (Feeder/Mother):", v.type);
      if (newVessel && newVoyage && newType) {
        vessels[i] = { vessel: newVessel, voyage: newVoyage, type: newType };
        saveData();
        renderTable();
      }
    };

    // === HAPUS DARI FIREBASE ===
    async function deleteVesselFromFirebase(vessel, voyage) {
      const vesselId = `${vessel.replace(/\s+/g, "_")}_${voyage}`;
      const vesselRef = doc(db, "stuffing", agent, "vessels", vesselId);

      try {
        // Hapus semua dokumen di subcollection "details"
        const detailsRef = collection(db, "stuffing", agent, "vessels", vesselId, "details");
        const detailsSnap = await getDocs(detailsRef);
        for (const d of detailsSnap.docs) {
          await deleteDoc(d.ref);
        }

        // Hapus dokumen vessel utama
        await deleteDoc(vesselRef);
        console.log(`‚úÖ Vessel ${vesselId} berhasil dihapus dari Firebase`);
      } catch (err) {
        console.error("‚ùå Gagal hapus dari Firebase:", err);
      }
    }

    // === HAPUS DATA DARI LOCAL + FIREBASE ===
    window.deleteVessel = async (i) => {
      const v = vessels[i];
      if (confirm(`Hapus vessel "${v.vessel}" (voyage ${v.voyage})?`)) {
        vessels.splice(i, 1);
        saveData();
        renderTable();
        await deleteVesselFromFirebase(v.vessel, v.voyage);
      }
    };

    // === TAMBAH DATA BARU ===
    addForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const vessel = addForm.vesselName.value.trim();
      const voyage = addForm.voyageNumber.value.trim();
      const type = addForm.vesselType.value;

      if (!vessel || !voyage) return alert("Lengkapi semua field!");

      if (vessels.some(v => v.vessel === vessel && v.voyage === voyage)) {
        alert("‚ùå Vessel dengan voyage tersebut sudah ada!");
        return;
      }

      vessels.push({ vessel, voyage, type });
      saveData();
      addForm.reset();
      renderTable();

      // Simpan ke Firebase
      const vesselId = `${vessel.replace(/\s+/g, "_")}_${voyage}`;
      const vesselRef = doc(db, "stuffing", agent, "vessels", vesselId);
      await setDoc(vesselRef, {
        vessel,
        voyage,
        type,
        createdAt: new Date().toISOString(),
      });

      alert("‚úÖ Data vessel berhasil disimpan ke Firebase!");
    });

    // === FITUR SEARCH DAN FILTER ===
    const searchInput = document.getElementById("searchInput");
    const filterSelect = document.getElementById("filterSelect");

    function filterVesselTable() {
      const keyword = searchInput.value.toLowerCase();
      const filter = filterSelect.value;
      const rows = document.querySelectorAll("table tbody tr");

      rows.forEach(row => {
        const cells = row.querySelectorAll("td");
        const data = {
          vessel: cells[0]?.textContent.toLowerCase() || "",
          voyage: cells[1]?.textContent.toLowerCase() || "",
          type: cells[2]?.textContent.toLowerCase() || "",
        };

        let match = false;
        if (filter === "all") {
          match = Object.values(data).some(v => v.includes(keyword));
        } else {
          match = data[filter]?.includes(keyword);
        }

        row.style.display = match ? "" : "none";
      });
    }

    searchInput.addEventListener("input", filterVesselTable);
    filterSelect.addEventListener("change", filterVesselTable);

    // === RENDER AWAL ===
    renderTable();
  </script>
</body>
</html>
